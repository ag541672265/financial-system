define(["trial","jquery-tab","detail","helper","base","jquery-prompt"],function(c,t,e,n,f){"use strict";return{init:function(){var t=this;t.getLeaderClubProduct(),t.getProductInfo(function(){t.trial(),t.detialTab(),t.recommendTab(),t.review(),t.guide(),e.init(t.trialBox),t.event(),t.initFacebookPixelEvent(),t.renewal(),t.execProductListFilters()})},getLeaderClubProduct:function(){var r;n.request.getJson({url:"/api/products/leaderClub/queryByKey",data:{key:"tour_leader.group_buy.product_id-tour_leader.member_only.product_id-tour_leader.product_mapping"}},function(t){var e=t.result.data||[];r=[],e.forEach(function(t){if("tour_leader.product_mapping"==t.key){var e="{}";try{e=JSON.parse(t.value)}catch(a){e=t.value.replace(/\{|\:|\,|\}/g,function(t,e){return{"{":'{"',":":'":"',",":'","',"}":'"}'}[t]}),e=JSON.parse(e)}window["__leaderclubProductMapping"]=e}else Array.prototype.push.apply(r,t.value.split(","))}),window["__leaderOnly"]=r})},initFacebookPixelEvent:function(){$("body").on("click",".facebook-collection-click-toubao",function(){fbq("track","InitiateCheckout")}),$("body").on("click",".hz-button-secondary",function(){fbq("track","AddToCart")})},event:function(){$("#detailTabs").on("click","li",function(){var t=0+($(".top-nav-wrap").outerHeight()||0)+($(".hz-header-wrap").outerHeight()||0)+($("#detialTab").outerHeight()||0)-($(".detail-hz-tab-box").outerHeight()||0)+($(".detail-hz-tab-boxs").outerHeight()||0);$("html,body").scrollTop(t||196),0===$(this).index()&&setTimeout(function(){$("#silderbar").addClass("fixed-sidebar")},300)})},detialTab:function(){var t={titleCurrent:"active",contentCurrent:"show"},e=$("#DataAnalysis").val();2==+(0<$("#shuntMark").length?$("#shuntMark").val():0)&&""!=e&&(t.index=1),$("#detailTabs").tab("#detialTabContent",t)},guide:function(){$("#guideTabs").on("hover","li[data-tab]",function(){$("#guideTabs li").removeClass("active"),$(this).addClass("active"),$("#guideContentTabs > div").hide(),$("#guideContentTabs > div[data-tab='"+$(this).attr("data-tab")+"']").show()})},recommendTab:function(){$("#recommendTable").tab("#recommendTableContent",{titleCurrent:"active",contentCurrent:"show",onComplete:function(t,e,a,r){}})},getProductInfo:function(e){var a=this,t=location.href+(-1!==location.href.indexOf("?")?"&":"?")+"getRules=true";$.get(t,function(t){a.data=t,e&&e(t)})},trialBox:{},trialInstance:{},trial:function(){var t,e,a=this,r=($("#productPlanName"),$("#productId").val()),i=$("#planId").val(),n=$("#baseProductId").val(),l=$("#basePlanId").val(),o=$("#defaultInsureTime").val(),s=c.prototype.getQueryValue("DProtectPlanId"),u={el:$("#trialWrap"),genesArea:$(".trail-genes-list"),protectArea:$(".trial-protect-list"),renderData:a.data.restrictRules[0],data:a.data,productId:r,productPlanId:i,baseProductId:n,baseProductPlanId:l,defaultInsureTime:o||"",ready:function(){var t=this,e=[],a=[];e.push('<div class="trail-genes-list ">'),e.push(this.renderGenes()),e.push("</div>"),a.push(this.renderProtect()),$("#trialAreasGenes").html(e.join("")),$("#protectArea").html(a.join("")),this.genesArea=$(".trail-genes-list"),setTimeout(function(){t.eventInit()},0)},change:function(){this.trialPrice&&$("[preminum]").html(this.setPrice())},getServiceTimeUrl:"/api/tools/date/now",serchJobUrl:"/search/job",debug:function(){var t,e=c.prototype.getQueryValue("dev");try{t="true"===localStorage.getItem("dev")}catch(a){}return e&&(t="true"===e),t}()};c.prototype.getQueryValue("dev"),e=new c(u),a.trialBox[i]=e,$(function(){$('[rel="prompt"]').prompt({position:"top"})}),t=$("#planId"),s&&t.val(s),s||($("#planIdBox").find(".filter-tag").eq(0).addClass("filter-active-tag"),$(".trail-genes-list").eq(0).show()),window.trialBox=a.trialBox,window.trial=this.trialInstance=e},review:function(){$('[id="reviewTable"]').tab("[id=reviewTableContent]",{titleCurrent:"active",contentCurrent:"show"})},renewalNum:"",isRenewal:!1,renewal:function(){var l=this,t=n.url.getUrlVar("ep");if(t){var i={};(t=t.split("~")).forEach(function(t,e){var a=t.split("_")[0],r=t.split("_")[1];i[a]=r}),l.renewalNum=i.ins,l.isRenewal="1"===i.IsRenewal}l.renewalNum&&l.isRenewal&&$.ajax({url:"/api/insurance-slips/renewal/insured?renewalNum="+l.renewalNum+"&t="+(new Date).getTime(),type:"get",success:function(t){var e=t.result,a=$("#planId").val(),r=new Date(e.birthdate),i=$("#trialAreas .trial-item[data-key=insurantDate]");if(0<i.length&&i.hasClass("Wdate")){var n=l.getBirthdateTimePeriod(i);r<=n.maxDate&&r>=n.minDate&&(l.trialBox[a].setOldValue(i,i.val()),i.val(e.birthdate),l.trialBox[a].postChange())}1<i.length&&i.each(function(t,e){var a=l.getBirthdateTimePeriod($(this));r<=a.maxDate&&r>=a.minDate&&$(this).click()}),setTimeout(function(){var t;(t=e.sex?$("#trialAreas  .trial-item[data-key=sex][data-default-value=男]"):$("#trialAreas  .trial-item[data-key=sex][data-default-value=女]")).hasClass("filter-active-tag")||t.click()},200)},error:function(t){}})},getBirthdateTimePeriod:function(t){var e={},a=new f,r=t.data("list")||"[]",i=r.max||0,n=r.min||0,l=r.unit||0,o=0,s=0,u=0,c=0;if("岁"!==a.getUnit(l)&&"周岁"!==a.getUnit(l)||(o=n,s=i),r.subrestrict&&"天"===a.getUnit(r.subrestrict.unit)){var d=r.subrestrict.max,h=r.subrestrict.min;d&&(u=d),h&&(c=h)}var p=a.createDate({newDate:a.getCurrentTime(new Date),year:-o,date:u}),v=a.createDate({newDate:a.getCurrentTime(new Date),year:-s-1,date:c});return e.maxDate=new Date(p),e.minDate=new Date(v),e},productFiltersGenesMap:{insurantDate:{name:"性别",test:1271,production:1299,less:"age",sort:0,idType:"key"},insurantDateLimit:{name:"保障期限",test:1271,production:1299,less:"insurantDateLimit",sort:1,idType:"key"}},execProductListFilters:function(){var t=decodeURIComponent(n.url.getUrlVar("filters"));if(t){var a=[],r=t.split("_");r.forEach(function(t,e){e%2==0&&a.push([t,r[e+1]])});var e=this.getValidFilters(a);this.execFilterTrial(e)}},getValidFilters:function(t){var i=[],n=this;return t.forEach(function(t){for(var e in n.productFiltersGenesMap){var a=n.productFiltersGenesMap[e],r={};a["test"]!=t[0]&&a.less!==t[0]||(r.value=t[1],r[a.idType]=e,r.sort=a.sort,i.push(r))}}),i=i.sort(function(t,e){return t.sort>e.sort})},execFilterTrial:function(t){var a=this,r=(t||[]).length,i=(t||[]).concat([]),n=function(t){if(t<r){var e=a.getFilterTrialParams(i[t]);e&&a.trialInstance.postChangeData(e,function(){i.splice(t,1),r--,n(t)})}};0!==r&&n(0)},getFilterTrialParams:function(e){var a=this,t=this.trialInstance.getGenesData(),r="",i="",n=/^\d+-\d+-\d+$/.test(e.value);return t.forEach(function(t){if(t.key&&t.key===e.key||t.protectItemId&&t.protectItemId===e.protectItemId)switch(+t.controlType){case 0:r=a.judValueInGene(t.$el,e.value);break;case 1:"insurantDate"===e.key&&n&&(r=a.judDateControl(t.$el,e.value))}}),r&&(i=this.getFilterPostTrialData(r)),i},eachGenesValueItems:function(t,i){t.find(".trial-item").each(function(t,e){var a=$(e),r=a.data("default-value")||a.data("value")||a.val()||"";i(t,r,a)})},judValueInGene:function(t,i){function n(t,e){if(!t.hasClass(l.trialInstance.activeStyle)&&!t.closest(".hz-dropdown").hasClass(l.trialInstance.activeStyle))if(r={key:t.data("key"),protectItemId:t.data("protectitemid"),value:e},t.hasClass("hz-select-option")){var a=t.closest(".hz-dropdown");a.addClass(l.trialInstance.activeStyle).siblings().removeClass(l.trialInstance.activeStyle),a.find(".input-select-text").text(e)}else t.addClass(l.trialInstance.activeStyle).siblings().removeClass(l.trialInstance.activeStyle)}var r,l=this,o=((i.match(/\d+-\d+/)||[])[0]||"").split("-"),s=/^\d+-\d+-\d+$/.test(i),u=s?this.getFullAge(i):(i.match(/\d+/)||[])[0]||"";return this.eachGenesValueItems(t,function(t,e,a){var r=((e.match(/\d+-\d+/)||[])[0]||"").split("-");1<o.length&&!s?1<r.length&&r[0]<=+o[0]&&r[1]>=+o[1]&&n(a,e):1<r.length&&r[0]<=+u&&r[1]>+u&&""!==u?n(a,e):e===i&&n(a,e)}),r},getFilterPostTrialData:function(e){var t="",a=this.trialInstance.getGenes()||[],r={};return a.forEach(function(t){(t.protectItemId&&t.protectItemId===e.protectItemId||t.key&&t.key===e.key)&&(r.value=t.value,r.protectItemId=t.protectItemId,r.key=t.key,t.value=e.value)}),$.isEmptyObject(r)||(t=JSON.stringify(this.trialInstance.getProductInfo({genes:a,optGeneOldValue:r}))),t},judDateControl:function(t,e){var a,r=t.find(".Wdate").data("list"),i=this.getFullAge(e);return r&&i&&r.min<=+i&&r.max>=+i&&(a={key:t.data("key"),protectItemId:t.data("protectitemid"),value:e},t.find(".Wdate").val(a.value).attr("value",a.value)),a},getFullAge:function(t){var e,a,r,i=new Date,n=new Date(t),l=0;return e=i.getFullYear()-n.getFullYear(),a=i.getMonth()-n.getMonth(),r=i.getDate()-n.getDate(),a<0?l=-1:0==a&&r<0&&(l=-1),e+l}}});