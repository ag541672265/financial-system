define(["jquery","underscore","exports","require","module","helper","layer"],function($,n,e,t,o,u,r){"use strict";var d,c,h=!1,m=0<$("#shuntMark").length?$("#shuntMark").val():0,a="checkCompareIds",l="compareProducts",i=function(){i.prototype.init.apply(this,arguments)};(window.ToolFloat=i).prototype={kefuStatus:!1,showKefu:function(){var e=this;$(".online-kefu").addClass("side-tool-current"),$(".kefu-box").animate({right:35},function(){e.kefuStatus=!0})},hideKefu:function(){var e=this;$(".online-kefu").removeClass("side-tool-current"),$(".kefu-box").animate({right:-30},function(){e.kefuStatus=!0})},setGA:function(){$("body").on("click",".kefu-icon",function(){/www.huize.com\/$/gi.test(location.href)?(ga&&ga("send","event","pc","public","hz_pc_public_f1",1),customTrack("hz_pc_public_f1_zaixiankefu")):-1!==location.href.indexOf("product/ins-")&&(ga&&ga("send","event","pc","public","hz_pc_liebiaoye_zaixiankefu",1),customTrack("hz_pc_liebiaoye_zaixiankefu"))})},init:function(e){var i=this;this.config=e,t(["require-text!/html/product/fixed-tool-float.html"],function(e){$("body").append(e),c=$("#fixedsidetool"),i.initAction();var t=u.cookie.getCookie(l),o=$.grep(t.split(","),function(e){return""!==e});$("#compareCount").html(o.length+"/4"),i.refreshShopCar(),i.refreshToolPosition(!0),i.scrollEvent(),i.initNewIcon(),i.setGA(),setTimeout(function(){i.kefuStatus=!0},1e3),function a(o){function i(){return $("html").scrollTop()}var n=i();o=o||function(){},$(window).scroll(function(){var e=i(),t=e-n;if(0==t)return!1;o(0<t?"down":"up"),n=e})}(function(e){i.kefuStatus&&(i.hideKefu(),i.kefuStatus=!1)}),setTimeout(i.hideKefu,3e3)})},isIe6:function(){if(/msie/.test(navigator.userAgent.toLowerCase()))return!(!jQuery.browser||!jQuery.browser.version||"6.0"!=jQuery.browser.version)},initNewIcon:function(){0<$(".index-page").length?$("#wxQrCode").removeClass("fn-hide"):($("#toolQRcode").addClass("side-tool-current"),$("#hwydQrCode").removeClass("fn-hide")),setTimeout(function(){$("#toolQRcode").removeClass("side-tool-current")},3e3)},scrollEvent:function(){var e=this,t=$("#fixedsidetool")[0];e.isIe6()&&($("#fixedsidetool").height($(window).height()),$(window).on("scroll resize",function(){e.setPosition(t)}))},setPosition:function(e){for(var t=e,o=0,i=t;i=i.offsetParent;)o+=i.offsetTop;t.style.top=Math.max(document.body.scrollTop,document.documentElement.scrollTop)-o+0+"px"},initAction:function(){var s=$("#toolPanel",c),e=$("#panelTitle",c),t=/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent),n=this;$("body").on("mouseenter",".online-kefu",function(){clearTimeout(n.timer),n.showKefu()}).on("click","#hideKefu",function(){clearTimeout(n.timer),n.hideKefu()}).on("mouseleave",".online-kefu",function(){n.timer=setTimeout(function(){n.hideKefu()},500)}),c.on("click","#showCarBtn",function(){s.show(),$(".comparer-item",c).addClass("fn-hide"),$(".car-item:not(.items-empty)",c).removeClass("fn-hide"),$("#feedCallback").addClass("fn-hide"),h&&$("#loginBtn").addClass("fn-hide"),n.refreshShopCar(!0),e.html("购物车"),n.setFixTogglePosition(1),1==+m?(ga("send","event","toubao","PCtoubao","JPCXiangQingGouWuCheCR",1),"function"==typeof customTrack&&customTrack("JPCXiangQingGouWuCheCR")):2==+m&&(ga("send","event","toubao","PCtoubao","PCXiangQingGouWuCheaR",1),"function"==typeof customTrack&&customTrack("PCXiangQingGouWuCheaR"))}).on("click","#loginBtn",function(){requirejs(["sign-float"],function(e){new e({returnUrl:location.href,showRegister:!1,callback:function(e){location.reload()}})})}).on("click","#deleteAll",function(){u.cookie.setCookie(l,"",432e6,".huize.com"),n.loadComparePro(),$("#compareTips,#comparerItemTip,#deleteAll",c).addClass("fn-hide"),u.cookie.setCookie(a,"",null,".huize.com"),n.setStartComparaStats(0),$("#addToCompare").removeClass("hz-check-item-checked"),$("#addToCompare .hz-check-text").text("加入对比")}).on("click","#comparePanel .hz-check-item",function(){$(this).toggleClass("hz-check-item-checked");var e,t=$(this).attr("planId"),o=u.cookie.getCookie(a);e=$(this).hasClass("hz-check-item-checked")?n.cookieStr(o,t,1):n.cookieStr(o,t,2),u.cookie.setCookie(a,e,null,".huize.com");var i=$("#comparePanel .hz-check-item-checked");n.setStartComparaStats(i.length)}).on("click","#toPay",function(){u.page.openNewTag("//is.huize.com/shopping-cart/")}).on("click","#showProductBtn",function(){s.show(),$(".comparer-item:not(.items-empty)",c)&&($(".comparer-item:not(.items-empty)",c).removeClass("fn-hide"),$("#compareTips,#comparerItemTip,#deleteAll").addClass("fn-hide")),$(".car-item",c).addClass("fn-hide"),$("#feedCallback").addClass("fn-hide"),e.html("产品对比"),n.loadComparePro(),n.setFixTogglePosition(1)}).on("click","#startCompara",function(){var e=$("#comparePanel .hz-check-item-checked");if(e.length<2)r.msg("对比的产品不能小于两个");else{var o="//www.huize.com/contrast-0-0-0-0";e.each(function(e,t){e<4&&(o=o.replace("-0","-"+$(t).attr("planId")))}),u.page.openNewTag(o)}}).on("click","#comparePanel .hz-close",function(){var e=$(this).attr("planId");n.delcomparePro(e);var t=$("#comparePanel .hz-check-item-checked");n.setStartComparaStats(t.length)}).on("click",".side-tool-back",function(){s.hide()}).on("click","#toolFeedBtn",function(){s.show(),$(".comparer-item",c).addClass("fn-hide"),$(".car-item",c).addClass("fn-hide"),$("#feedCallback").removeClass("fn-hide"),$("#panelTitle").html("意见反馈"),$("#feedback-area").placeholder({blankCharacter:!1,wrapTagName:!1})}).on("click","#feedCall",function(){var t=this,e=$.trim($(".side-tool-feedback-area").val()),o=$("#feedCallback  .js-questions-type li.active"),i=$("#feedCallback .hz-alert-error");if(o.length<1)i.eq(0).html("请选择问题类型");else if(i.eq(0).html(""),e){if(500<e.length)i.eq(1).html("内容不能超过500个字");else if(!$(this).attr("posting")){$(this).attr("posting","true"),i.html(""),$(this).html("正在提交......");var n=[];$.each(o,function(e,t){n.push($(this).html())});var a={feedbackType:n.join(","),contactWay:$("#feedBackContactWay").val()||"",sourceDetail:location.href,content:e};u.request.postData2({url:"/api/users/feedback",data:a},function(e){e.Message?i.html(e.Message):(i.html(""),r.msg("提交成功"),s.hide(),$("#feedCallback  .js-questions-type li.active").removeClass("active"),$("#feedCallback  .side-tool-feedback-area").val(""),$("#feedCallback  #feedBackContactWay").val("")),$(t).attr("posting",""),$(t).html("提交")})}}else i.eq(1).html("内容不能为空")}).on("mouseover",".tool-function-item",function(e){$(this).addClass("side-tool-current"),"toolQRcode"!=e.currentTarget.id&&$("#toolQRcode").removeClass("side-tool-current")}).on("mouseout",".tool-function-item",function(e){$(this).hasClass("online-kefu")||"toolQRcode"!=e.currentTarget.id&&$(this).removeClass("side-tool-current")}).on("keydown",".side-tool-feedback-area",function(e){var t=$.trim($(this).val()).length+1;return 8===e.keyCode||!(500<t)&&void 0}).on("click","#kefu",function(){1==+m?(ga("send","event","toubao","PCtoubao","JPCXiangQingKeFu",1),"function"==typeof customTrack&&customTrack("JPCXiangQingKeFu")):2==+m&&(ga("send","event","toubao","PCtoubao","PCXiangQingKeFuaR",1),"function"==typeof customTrack&&customTrack("PCXiangQingKeFuaR"));var e=["2072","2073","2078","2079","2081"],t=-1!==$.inArray($("#categoryId").val(),e),o=u.jointReferrer(),i="//is.huize.com/api/users/kefuRewrite?referrer="+encodeURIComponent(o)+"&title="+encodeURIComponent(document.title);if(-1<location.pathname.indexOf("/ketang")&&(i+="&businessType=79udksVCTQ0"),-1<location.pathname.indexOf("/product/ins-")){var n=location.pathname.match(/-(\d+)-/);i+="&businessType="+(n&&-1!==$.inArray(n[1],e)?"Xm4FWr0dncw":"79udksVCTQ0")}if(-1<location.pathname.indexOf("/brand/detail/")&&(i+="&businessType="+(-1!==$.inArray($("#subCategory").val(),e)?"Xm4FWr0dncw":"79udksVCTQ0")),-1!=location.pathname.indexOf("/product/detail")&&(i+="&productTypeId="+$("#categoryId").val(),t||(i+="&businessType=79udksVCTQ0"),customTrack("PCXiangQingKeFua")),"qy.huize.com"===location.hostname){i+="&businessType=79udksVCTQ0";try{ga("send","event","pc","seo","hz_pc_seoliebiao_zaixiankefu",1),customTrack("hz_pc_seoliebiao_zaixiankefu")}catch(l){}}var a=new Date,s=a.getDay(),r=a.getHours();if(0<s&&s<6&&9<=r&&r<=22&&t&&(i+="&businessType=RtcviZnIMNU"),h){if(d&&d.userId){var c=u.cookie.getCookie("userId");i+="&mid="+encodeURIComponent(c)}d&&d.adviserInfoList&&1===d.isBind&&0!==d.adviserInfoList.length&&(i+="&consultant="+encodeURIComponent(d.adviserInfoList[0].employeeNo))}window.open(i,"kefu","toolbar=no,location=no,directories=no,resizable=yes,status=yes,menubar=no,scrollbars=yes,width=800,height=600,left=0,top=0")}).on("click","#feedCallback  .js-questions-type li",function(){$(this).toggleClass("active")}).on("click",".js-feedback-kefu",function(){$("#kefu").click()});var o=t?"touchend":"click";$("html").bind(o,function(e){$(e.target).parents("#fixedsidetool").length||$(e.target).parents(".layui-layer-dialog").length||(s.hide(),$("#toolQRcode").removeClass("side-tool-current"),n.setFixTogglePosition(0))});window.onresize=function(){n.refreshToolPosition(),0<$("#detialTab").length&&function(){var e=window.document.body.clientWidth||0;$("#detialTab").hasClass("fixed-detail-tab-wrap")&&e<1190?$("#detialTab .layout").width(e):$("#detialTab .layout").width(1190),$("#silderbar").hasClass("fixed-sidebar")&&e<1190?$("#silderbar").css("right","6px"):$("#silderbar").css("right","auto")}()},setInterval(function(){var e=$.trim($(".side-tool-feedback-area",c).val());$("#charCount",c).html(e.length)},500)},refreshToolPosition:function(e){var t=this,o=window.document.body.clientWidth,i=$("#fixedsidetool"),n=$("#wrapToolMenu");window.document.documentElement.clientHeight;o<1262?(e?(i.css("right","-35px"),n.css({position:"relative",left:"-35px"})):0===$("#toolPanel:visible").length&&(i.animate({right:"-35px"},30),n.css({position:"relative"}).animate({left:"-35px"},100)),i.bind("mouseleave",function(){t.needFixToggle()||0===$("#toolPanel:visible").length&&(i.animate({right:"-35px"},100),n.animate({left:"-35px"},100))}),n.bind("mouseover",function(){t.needFixToggle()||($(this).animate({left:"0"},30),i.animate({right:"0"},30))})):(e?(i.css("right",0),n.css({position:"relative",left:"0"})):(i.animate({right:"0"},300),n.css("position","relative").animate({left:"0"},300)),n.unbind("mouseover"),i.unbind("mouseleave"))},refreshShopCar:function(t){var a=this;u.state.checkLogin(function(e){if(h=e.result){if(u.request.getJson({url:"/api/shopping-cart/items/count"},function(e){$("#fixedsidetool #carItemCount").html(e.result),$(".hz-header-cart-num").html(e.result)}),u.request.getJson({url:"/api/users/customer-service"},function(e){d=e.result}),!t)return}else;u.request.getJson({url:"/api/shopping-cart/list"},function(e){if(e.message)r.msg(e.message);else{var t=e.result,o=0;t.length?($(".car-item.items-empty").addClass("fn-hide"),n.each(t,function(e){o+=e.cartItems.length+e.cartProjectPlans.length}),$("#carItemCount",c).html(o),$(".hz-header-cart-num").html(t.length)):($(".car-item.items-empty").removeClass("fn-hide"),$("#carItemCount",c).html(0),$(".hz-header-cart-num").html(0)),$("#shopcarList",c).html(n.template($("#shopcarhtml").html())({datas:t})),$("#failList",c).html(n.template($("#failItems").html())({datas:t})),0<$("#failList li",c).length&&$("#failList").parent().removeClass("fn-hide");var i=[];$("#shopcarList li",c).each(function(e,t){var o=$(this);"plan"===(o.attr("data-type")||"")?o.find(".plan-hidden").each(function(){i.push({insuranceNum:$(this).attr("insureNum"),premium:$(this).attr("premium")})}):i.push({insuranceNum:o.attr("insureNum"),premium:o.attr("premium")})}),0!==i.length?u.request.postData2({url:"/api/insurance-slips/amount/choosed",data:i},function(e){e.result&&$("#totalPrice").html(((e.result.totalPremium-e.result.totalDiscount)/100).toFixed(2))}):$("#totalPrice").html("0.00"),a.refreshCount(),$("#shopcarList,#failList",c).delegate(".delbtn","click",function(){var n=this;r.confirm('<p class="pt45 pb45 tac">确认要从购物车中删除该产品吗？</p>',{btn:["取消","确定"],area:"530px",title:!1},function(){r.closeAll()},function(){var e=$(n).attr("data-type")||"";if(h){var t="";t="plan"===e?"/api/shopping-cart/items?projectInsuranceGroup="+$(n).attr("data-group")+"&type="+e:"/api/shopping-cart/items?insuranceNum="+$(n).attr("pid"),u.request.postData2({url:t,method:"DELETE"},function(e){e.result?(r.msg("删除成功"),a.refreshShopCar(!0)):r.msg("删除失败")})}else{var o=u.cookie.getCookie("InsureNums"),i=$(n).attr("pid");"plan"===e?$(n).parents("li").find("input[type=hidden]").each(function(){var e=$(this).attr("insurenum");u.cookie.setCookie("InsureNums",a.cookieStr(o,e),0,".huize.com"),o=u.cookie.getCookie("InsureNums")}):u.cookie.setCookie("InsureNums",a.cookieStr(o,i),0,".huize.com"),r.msg("删除成功"),a.refreshShopCar(!0)}})})}})})},refreshCount:function(){$("#productCount",c).html($("#shopcarList li").length),$("#failCount",c).html($("#failList li").length)},loadComparePro:function(){var e=u.cookie.getCookie(l),o=this,t=[];e&&(t=e.split(",")),(t=$.grep(t,function(e){return""!==e})).length?($(".comparer-item.items-empty").addClass("fn-hide"),$("#compareTips,#comparerItemTip,#deleteAll").removeClass("fn-hide")):$(".comparer-item.items-empty").removeClass("fn-hide"),u.request.postData2({url:"/api/products/plans/list",data:t},function(e){$("#comparePanel").html(n.template($("#comparehtml").html())({datas:e.result})),$("#compareCount #fixedsidetool").html(e.result.length+"/4"),$("#compareCount").html(e.result.length+"/4");var t=u.cookie.getCookie(a);$("#comparePanel .hz-check-item").each(function(){-1<t.indexOf($(this).attr("planId"))&&$(this).addClass("hz-check-item-checked")}),o.setStartComparaStats($("#comparePanel .hz-check-item-checked").length)})},setStartComparaStats:function(e){1<e?($("#compareTips").addClass("fn-hide"),$("#startCompara").removeClass("disabled")):($("#compareTips").removeClass("fn-hide"),$("#startCompara").addClass("disabled"),0===e&&$("#deleteAll").addClass("fn-hide"))},getCompareCount:function(){var e=u.cookie.getCookie(l);return-1<e.indexOf("|")&&(e=""),e=e.split(","),(e=$.grep(e,function(e){return""!=e})).length},delcomparePro:function(e){var t=u.cookie.getCookie(l);-1<t.indexOf("|")&&(t=""),t=(t=this.cookieStr(t,e)).split(","),t=$.grep(t,function(e){return""!=e}),$("#compareCount").html(t.length+"/4"),u.cookie.setCookie(l,t.join(","),432e6,".huize.com");var o=u.cookie.getCookie(a),i=this.cookieStr(o,e,2);u.cookie.setCookie(a,i,null,".huize.com"),this.loadComparePro()},addcomparePro:function(e){var t=u.cookie.getCookie(l),o=u.cookie.getCookie(a);if(-1<t.indexOf("|")&&(t=""),!(4<(t=this.cookieStr(t,e,1)).split(",").length))return o=this.cookieStr(o,e,1),u.cookie.setCookie(a,o,null,".huize.com"),$("#compareCount").html(t.split(",").length+"/4"),u.cookie.setCookie(l,t,432e6,".huize.com"),this.loadComparePro(),!0;r.msg("对比数目最大不能超过4个")},cookieStr:function(e,t,o){var i=e.split(",");if(i=$.grep(i,function(e){return""!==e}),1===o){for(var n=0;n<i.length;n++)if(i[n]===t)return i.join(",");i.push(t)}else for(n=0;n<i.length;n++)if(i[n]===t)return i.splice(n,1),i.join(",");return i.join(",")},needFixToggle:function(){var e=!1,t=window.navigator.userAgent,o=-1<t.indexOf("Android")||-1<t.indexOf("Adr"),i=/(iPhone|iPad|iPod|iOS)/i.test(t);return(o||i)&&(e=!0),e},setFixTogglePosition:function(e){if(e!==undefined&&this.needFixToggle()){var t=$("#wrapToolMenu"),o=$("#fixedsidetool"),i=t.css("left"),n=o.css("right");0===e?(-35!==parseInt(i)&&t.css("left","-35px"),-35!==parseInt(n)&&o.css("right","-35px")):1===e&&(0!==parseInt(i)&&t.css("left","0px"),0!==parseInt(n)&&o.css("right","0px"))}}},o.exports=i});